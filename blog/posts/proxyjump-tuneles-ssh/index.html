<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MW9RRK2');</script>

<link href='https://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://sysarmy.com/blog//css/style.css">

    <meta charset="utf-8">
    <link rel="shortcut icon" href="https://sysarmy.com/favicon.png" />
    <link rel="apple-touch-icon" href="https://sysarmy.com/favicon.png" />	
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="description" content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">
<meta name="keywords" content="sysadmin, ssh, proxy, jumphost, ">

 		<meta name="author" content="sysarmy">
        <meta property="fb:admins" content="218813981488432"/>
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@sysarmy">
        <meta name="twitter:creator" content="@sysarmy">
    
        <title>Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar</title>
        <meta property="og:title" content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">
        <meta property="twitter:title" content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">
        <meta property="og:type" content="article">
        <meta property="article:published_time" content="2020-12-19">
        <meta property="og:description" content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">
        <meta property="twitter:description" content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">
        <meta name="description" content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">
    
        <meta property="og:url" content="https://sysarmy.com/blog/posts/proxyjump-tuneles-ssh/">
        <meta property="og:site_name" content="sysarmy">
    
            <meta property="og:image" content="assets/proxyjump_5_akrI3NN_Ai7lO1ci.jpg">
            <meta property="twitter:image" content="assets/proxyjump_5_akrI3NN_Ai7lO1ci.jpg">
    
    
            <meta property="og:tags" content="sysadmin">
    
            <meta property="og:tags" content="ssh">
    
            <meta property="og:tags" content="proxy">
    
            <meta property="og:tags" content="jumphost">
    


    <base href="https://sysarmy.com/blog/">
    <link rel="canonical" href="https://sysarmy.com/blog/posts/proxyjump-tuneles-ssh/">
    

</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MW9RRK2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>


<header id="header">
    <center>
      <a href="https://sysarmy.com/blog/" border=0><img src="https://sysarmy.com/blog//assets/logo.png" width="50%" height="50%" /></a>
    </center>
    <nav id="nav">
    
            El soporte de quienes dan soporte.

		<iframe src="https://open.spotify.com/embed-podcast/show/4aSX6qCCbNLmOUX4fftc5M" width="100%" height="232" frameborder="0" allowtransparency="true" allow="encrypted-media" style="margin-left:15px;margin-top:10px"></iframe>

		
		


            

    </nav>
</header>




<div id="fb-root"></div><script async defer crossorigin="anonymous"
src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v4.0&appId=319096484846369&autoLogAppEvents=1"></script>

<section id="main">
  <div>
  		<h1 itemprop="name" id="title">Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar</h1>
        <article itemprop="articleBody" id="content">
           <img src="assets/proxyjump_5_akrI3NN_Ai7lO1ci.jpg" alt="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

           <p>Hoy en día, es cada vez más común que los Penetration Testers, los investigadores de seguridad, Red Teams y <strong>casi cualquier persona que trabaje en sistemas</strong> requieran algún tipo de tunneling dentro y fuera de la infraestructura de una organización. Los red teams  internos, especialmente, que pueden necesitar delimitar su infraestructura de comando y control, probablemente emplearán túneles <a href="https://www.ssh.com/ssh/tunneling/" target="_blank">SSH</a>
 (o VPN, pero esa será en otra publicación) de su infraestructura externa (como callback servers, alojamiento web, correo, etc. ) hacia los activos Internos.</p>
<p>La configuración de estos túneles puede volverse bastante compleja y difícil de administrar, especialmente una vez que aumenta el número de saltos entre servidores.</p>
<h1 id="tunneling">Tunneling</h1>
<p><img src="assets/proxyjump_0_6CDo8qwaLsxZcFB8.jpg" alt=""></p>
<p>Los túneles SSH en cascada pueden ser un verdadero dolor de cabeza.
Para el propósito de esta publicación de blog, se ha configurado un entorno como se muestra a continuación. El objetivo es garantizar que los beacons de las víctimas puedan llegar al teamserver host que se encuentra en las profundidades del datacenter corporativo.</p>
<p><img src="assets/proxyjump_1_QtXI5oI-D15ceS3z.png" alt=""></p>
<p>Históricamente, debido a mi propia ignorancia de las opciones avanzadas de SSH, intentaría administrar estos múltiples túneles conectando en cascada cada túnel a otro:</p>
<p><img src="assets/proxyjump_2_zlM5vN8xcIZKD3Nt.png" alt=""></p>
<p>Para asegurar que las balizas lleguen al último salto podría llegar al teamserver interno, los comandos de túnel múltiples se ven así:</p>
<pre><code>[teamserver]
ssh -R 8080:127.0.0.1:80 internal-proxy -f -N

[Int. Proxy Server]
ssh -R 8080:127.0.0.1:8080 external-proxy -f -N

[Ext. Proxy Server ]
ssh -R 0.0.0.0:8080:127.0.0.1:8080 last-hop -f -N
</code></pre>
<p>Después de ejecutar cada uno de los respectivos comandos, una simple solicitud web demuestra que la solicitud web sigue a cada uno de los túneles hasta el teamserver.</p>
<p><img src="assets/proxyjump_3_qdDqfCNlcQPwJpIN.png" alt="">
<img src="assets/proxyjump_4_OaO9na6FNeG0C1Qz.png" alt=""></p>
<p>Configurar esto requiere que cada uno de estos comandos se ejecute en las respectivas máquinas. Sin embargo, cualquier cambio requiere matar el túnel en cada punto y volver a ejecutarlo. El dolor de cabeza en la práctica, sin algún tipo de software de administración que se ejecute en cada uno de los servidores, se vuelve muy evidente. Debe existir una forma más sencilla de gestionar estos túneles.</p>
<h1 id="proxyjump">ProxyJump</h1>
<p><img src="assets/proxyjump_5_akrI3NN_Ai7lO1ci.jpg" alt=""></p>
<p>Al igual que descubrimos el mes pasado sobre Aliens, ¡<a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts" target="_blank">ProxyJump</a>
 es algo real!
Entra <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts" target="_blank">ProxyJump</a>
, una opción avanzada de SSH que es simplemente una simplificación de ProxyCommand (<code>ProxyCommand ssh proxy-host -W% h:% p</code>). ProxyJump permite que un túnel SSH pivote a través de un host SSH (proxy) a otro. La opción ProxyJump puede ser invocada por <code>-J</code> en la línea de comando:</p>
<pre><code>ssh -J internal-proxy last-hop -f -N
</code></pre>
<p>Mi preferencia personal es usar una configuración SSH (<em>/home/user/.ssh/config</em>) y llaves SSH (si no, se le pedirá una contraseña para iniciar sesión en cada salto de ProxyJump). Aquí, se puede especificar un solo salto como tal para SSH:</p>
<pre><code>Host internal-proxy
   HostName 10.20.30.253
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump internal-proxy
</code></pre>
<p>Guardando el ejemplo anterior y ejecutando el comando <code>ssh last-hop</code>, el prompt de last-hop se presenta a continuación (con output de <code>netstat</code>). Se ve internal-proxy conectado a través del puerto TCP 22 y viceversa.</p>
<p><img src="assets/proxyjump_6_bMFeEgZWWmpBFNwR.png" alt=""></p>
<p>Ok, ¿qué pasa con los proxies múltiples? Como se hace referencia <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts" target="_blank">aquí</a>
, uno debe simplemente encadenar los proxies en el orden del más cercano al más lejano del servidor del equipo en la configuración SSH:</p>
<pre><code>Host internal-proxy
   HostName 10.20.30.253
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
Host external-proxy
   HostName 10.100.2.200
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump internal-proxy
Host next-hop
   HostName 10.100.2.210
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump external-proxy
Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump next-hop
</code></pre>
<p>Ejecutando <code>ssh last-hop</code> y luego ejecutando <code>netstat</code> desde last-hop, se muestra que <code>next-hop</code> es el único sistema conectado a través del puerto TCP 22 a <code>last-hop</code>:</p>
<p><img src="assets/proxyjump_7_zEVxPtJ0syTNhLta.png" alt=""></p>
<p>Entonces, ¿cómo ayuda esto a hacer un túnel hacia adelante? Bueno, simplemente agregando la línea <code>RemoteForward 8080 127.0.0.1:80</code> al final de la configuración SSH configurará el puerto remoto hacia adelante:</p>
<pre><code>Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump next-hop
   RemoteForward 8080 127.0.0.1:80
</code></pre>
<p>Después de guardar la configuración y ejecutar esta vez (<em>ssh last-hop</em>), un <code>netstat</code> rápido en  last-hop  muestra que 8080 ahora está vinculado. Además, el uso de curl para solicitar last-hop:8080 muestra que el túnel efectivamente reenvía cualquier solicitud de last-hop a través de next-hop, external-proxy e internal-proxy al teamserver en el puerto 80:</p>
<p><img src="assets/proxyjump_8_JpdH0YiLpskQvFcN.png" alt=""></p>
<p>Si diferentes hosts de salto usan archivos de identidad distintos, el usuario y el archivo de identidad solo necesitan coincidir con su respectivo host en la configuración. Por ejemplo, en nuestra configuración de demostración, usaremos user2 como una identidad en el proxy interno y nopriv en el last-hop:</p>
<pre><code>Host internal-proxy
   HostName 10.20.30.253
   Port 22
   User user2
   IdentityFile /home/nopriv/.ssh/user2
[…]
Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump internal-proxy
</code></pre>
<p>Ejecutando nuestro comando ssh last-hop ,presenta un inicio de sesión con éxito en el last-hop a través de internal-proxy, external-proxy y next-hop:</p>
<p><img src="assets/proxyjump_9_7-wR2SDk30xpHR_-.png" alt=""></p>
<p>El intercambio de llaves con internal-proxy verifica que las credenciales de user2 se usaron en la autenticación:</p>
<p><img src="assets/proxyjump_10_Q8gsu5j5Whabx-V_.png" alt=""></p>
<h1 id="conclusión">Conclusión</h1>
<p>En resumen, ProxyJump es una manera fácil de administrar túneles SSH a través de proxies, extendiendo servicios que pueden estar en las profundidades del datacenter corporativo o en la nube a donde se  los necesite. El uso de ProxyJump minimiza la cantidad de túneles separados requeridos y cuando se combinan configuraciones SSH, la modificación de dichos túneles es bastante simple y rápida.</p>
<ul>
<li><a href="https://medium.com/maverislabs/proxyjump-the-ssh-option-you-probably-never-heard-of-2d7e41d43464" target="_blank">Artículo Original</a>
</li>
<li>Traducción y ajuste <a href="https://github.com/GeekBeardLinks" target="_blank">modri</a>
 <a href="https://github.com/sysarmy/disneyland/issues/43" target="_blank">#43</a>
</li>
</ul>
           <div class="ve-desktop">
<ins class='dcmads' style='display:inline-block;width:728px;height:90px'
    data-dcm-placement='N410401.3634809SYSARMY.COMBLOG/B10464038.251052924'
    data-dcm-rendering-mode='iframe'
    data-dcm-https-only
    data-dcm-resettable-device-id=''
    data-dcm-app-id=''>
  <script src='https://www.googletagservices.com/dcm/dcmads.js'></script>
</ins>
</div>

<div class="ve-mobile">
<ins class='dcmads' style='display:inline-block;width:320px;height:50px'
      data-dcm-placement='N410401.3634809SYSARMY.COMBLOG/B10464038.250920272'
      data-dcm-rendering-mode='iframe'
      data-dcm-https-only
      data-dcm-resettable-device-id=''
      data-dcm-app-id=''>
  <script src='https://www.googletagservices.com/dcm/dcmads.js'></script>
</ins>
</div>
        </article>
  </div>
</section>




<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Sat Dec 19, 2020 </h4>
          <h5 id="wc"> 900 Palabras </h5>
          <h5 id="readtime"> Lectura en aprox. 5 Min </h5>
        </section>
        <ul id="tags">
          
            <li> <a href="https://sysarmy.com/blog//tags/sysadmin">sysadmin</a> </li>
          
            <li> <a href="https://sysarmy.com/blog//tags/ssh">ssh</a> </li>
          
            <li> <a href="https://sysarmy.com/blog//tags/proxy">proxy</a> </li>
          
            <li> <a href="https://sysarmy.com/blog//tags/jumphost">jumphost</a> </li>
          
        </ul>
    </div>
    <p><h4>Dejanos tu comentario:</h4></p>

    <div id="vanilla-comments"></div>
    <script type="text/javascript">
         
        var vanilla_forum_url = 'https://help.sysarmy.com/'; 
        var vanilla_identifier = "https:\/\/sysarmy.com\/blog\/posts\/proxyjump-tuneles-ssh\/"; 
        var vanilla_title = "Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar";

         
        
        var vanilla_category_id = '11'; 

         
        (function() {
            var vanilla = document.createElement('script');
            vanilla.type = 'text/javascript';
            var timestamp = new Date().getTime();
            vanilla.src = vanilla_forum_url + '/js/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(vanilla);
        })();
    </script>
    <noscript>
        Please enable JavaScript to view the
        <a href="http://vanillaforums.com/?ref_noscript">
            comments powered by /Help.
        </a>
    </noscript>

    <div>
        <section id="prev">
            &nbsp;<a class="previous" href="https://sysarmy.com/blog/posts/10-proyectos-para-automation-engineers/"><i class="icon-arrow-left"></i> 10 proyectos de portfolio para aspirantes a automation engineer</a><br>
        </section>
        <section id="next">
            &nbsp;
        </section>
    </div>

</aside>

<meta itemprop="wordCount" content="879">
<meta itemprop="datePublished" content="2020-12-19">
<meta itemprop="url" content="https://sysarmy.com/blog/posts/proxyjump-tuneles-ssh/">


<footer>
  <div>
    <p>
    &copy; <script>document.write(new Date().getFullYear())</script> <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Sysarmy.</span></span> Powered by <a href="http://gohugo.io">Hugo</a> based on <a href="https://spf13.com/">Steve Francia</a> theme.
    </p>
  </div>
</footer>


    
	
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
	<script src="js/load-photoswipe.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
	

</body>
</html>

